#! /usr/bin/perl

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# the usual fuss...

BEGIN { unshift @INC, ( $0 =~ /(.*?)((?<![^\/])bin\/)?[^\/]+$/ )[0] . "lib" }
use ReadConfig;
use MakeExt2Image;
use AddFiles;
use Conv2Image;
use CompressImage;

die "usage: $Script\n" if @ARGV;


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# some config data

$srcdir = "${DataPath}rescue";
$tmpdir = "${BasePath}tmp/rescue";
$image = "${ImagePath}rescue";

# leave that much space
$extra_size = 4000;              # kbyte
$extra_inodes = 2000;

# just make them large enough
$start_size = 150000;             # kbyte
$start_inodes = 30000;

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# now we really start...

$debug = exists($ENV{'debug'}) ? $ENV{'debug'} : "";
$use_cramfs = exists($ENV{'use_cramfs'}) ? $ENV{'use_cramfs'} : 1;

if($ENV{'keeprescue'} != 1) {
  # clean up
  if(-d($tmpdir)) {
    SUSystem "rm -rf $tmpdir" and die "$Script: failed to remove old $tmpdir";
  }

  $fl = exists($ENV{'filelist'}) ? $ENV{'filelist'} : "rescue";

  AddFiles $tmpdir, "${srcdir}/$fl.file_list", $srcdir or
    die "$Script: failed to setup rescue image";

  if(-f "${BasePath}tmp/rescue.rpmlog") {
    SUSystem "perl -pe 's/\\[(.*?)\\].*/\$1/' ${BasePath}tmp/rescue.rpmlog | sort -u >$tmpdir/.packages";
  }

  # SUSystem "sh -c 'cd $tmpdir; ./makedevs >/dev/null'" and
  #   die "$Script: could not create all devices";
  # SUSystem "rm $tmpdir/makedevs";

  # strip everything
  SUSystem "fix_perms $tmpdir";
  SUSystem "strip_dir $tmpdir";

  SUSystem "ldconfig -r $tmpdir";
  die "$Script: failed to run ldconfig" unless -f "$tmpdir/etc/ld.so.cache";

  if($debug =~ /\bignore\b/ || $debug =~ /\bignorelibs\b/) {
    system "check_libs $tmpdir" and
      warn "$Script: error in shared lib config, please fix\n";
  }
  else {
    system "check_libs $tmpdir" and
      die "$Script: error in shared lib config, please fix\n";
  }
}

if($use_cramfs) {
  Conv2Image $image, $tmpdir, 'cramfs';
  die "$Script: $!" unless rename $image, "$image.cramfs";
  $i = -s "$image.cramfs";
  print "$Script: created \"$image.cramfs\" ($i bytes)\n";
}
else {
  Conv2Image $image, $tmpdir, 'ext2', $start_size, $start_inodes, $extra_size, $extra_inodes;
  $i = CompressImage $image;
  print "$Script: compressed rescue to \"$image\" ($i bytes)\n";
}

